<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø³Ø­ Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .scanner-container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #2c3e50;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            color: white;
        }
        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #34495e;
            margin-bottom: 20px;
        }
        .scanner-title {
            font-size: 24px;
            font-weight: bold;
            color: #f39c12;
        }
        .scanner-window {
            width: 100%;
            height: 300px;
            background-color: #000;
            border: 4px solid #34495e;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        #interactive {
            width: 100%;
            height: 100%;
        }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #f39c12;
            top: 50%;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 15px #f39c12;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        .result-display {
            background-color: #34495e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .weight-section {
            text-align: center;
            margin-bottom: 15px;
        }
        .weight-value {
            font-size: 48px;
            font-weight: bold;
            color: #2ecc71;
            margin: 10px 0;
        }
        .unit {
            font-size: 24px;
            color: #3498db;
        }
        .details-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
        }
        .detail-box {
            background-color: #3d566e;
            padding: 10px 15px;
            border-radius: 6px;
            flex: 1;
            min-width: 120px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-stop {
            background-color: #e74c3c;
            color: white;
        }
        .btn-export {
            background-color: #3498db;
            color: white;
        }
        .btn-clear {
            background-color: #f39c12;
            color: white;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="scanner-header">
            <div class="scanner-title">Ù†Ø¸Ø§Ù… Ù…Ø³Ø­ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</div>
            <div class="scanner-status">
                <span id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</span>
            </div>
        </div>
        
        <div class="scanner-window">
            <div id="interactive"></div>
            <div class="scan-line" id="scan-line"></div>
        </div>
        
        <div class="result-display">
            <div class="weight-section">
                <div class="weight-value" id="weight-value">0.00</div>
                <div class="unit">ÙƒÙŠÙ„ÙˆØ¬Ø±Ø§Ù…</div>
            </div>
            <div class="details-section">
                <div class="detail-box" id="product-type">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬: ---</div>
                <div class="detail-box" id="net-weight">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ: ---</div>
                <div class="detail-box" id="expiry-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ---</div>
                <div class="detail-box" id="scan-time">ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø­: ---</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-stop" id="stop-btn">
                <span>â¹</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­
            </button>
            <button class="btn btn-clear" id="clear-btn">
                <span>ğŸ—‘ï¸</span> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn btn-export" id="export-btn">
                <span>ğŸ“¤</span> ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            </button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <audio id="scanSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" preload="auto"></audio>
    <audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>

    <script>
        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const weightValue = document.getElementById('weight-value');
        const productType = document.getElementById('product-type');
        const netWeight = document.getElementById('net-weight');
        const expiryDate = document.getElementById('expiry-date');
        const scanTime = document.getElementById('scan-time');
        const stopBtn = document.getElementById('stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const exportBtn = document.getElementById('export-btn');
        const statusText = document.getElementById('status-text');
        const scanLine = document.getElementById('scan-line');
        const notification = document.getElementById('notification');
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let scanHistory = [];
        let isScanning = true;
        let currentWeight = 0;
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', () => {
            initScanner();
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
        async function initScanner() {
            try {
                statusText.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";
                
                await Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactive'),
                        constraints: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: "environment",
                            aspectRatio: { ideal: 16/9 }
                        },
                    },
                    decoder: {
                        readers: ["qr_code_reader", "ean_reader", "code_128_reader"],
                        debug: {
                            drawBoundingBox: false,
                            showFrequency: false,
                            drawScanline: false,
                            showPattern: false
                        }
                    },
                    locate: true,
                    frequency: 10
                }, function(err) {
                    if (err) {
                        throw err;
                    }
                    Quagga.start();
                    statusText.textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­";
                });

                Quagga.onDetected(async function(result) {
                    const code = result.codeResult.code;
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const scanResult = processScannedText(code);
                    
                    if (scanResult.weight) {
                        currentWeight = scanResult.weight;
                        weightValue.textContent = currentWeight.toFixed(2);
                        
                        // ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
                        productType.textContent = `Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬: ${scanResult.productType || '---'}`;
                        netWeight.textContent = `Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ: ${scanResult.netWeight || '---'}`;
                        expiryDate.textContent = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${scanResult.expiryDate || '---'}`;
                        scanTime.textContent = `ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ø­: ${timeString}`;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
                        scanHistory.push({
                            time: timeString,
                            weight: currentWeight,
                            productType: scanResult.productType,
                            netWeight: scanResult.netWeight,
                            expiryDate: scanResult.expiryDate
                        });
                        
                        playScanSound();
                        showNotification(`ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙˆØ²Ù†: ${currentWeight.toFixed(2)} ÙƒØ¬Ù…`);
                        
                        // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¥Ù† Ø£Ù…ÙƒÙ†
                        if (navigator.vibrate) navigator.vibrate(100);
                    } else {
                        playErrorSound();
                        showError("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ÙˆØ²Ù† ØµØ§Ù„Ø­");
                    }
                });
                
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§Ø³Ø­:', err);
                statusText.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„";
                showError("ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©");
            }
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù…Ø³ÙˆØ­ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function processScannedText(text) {
            const result = {
                weight: null,
                netWeight: null,
                productType: null,
                expiryDate: null
            };
            
            // Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ÙˆØ²Ø§Ù† (Ù…Ù† Ø£Ù…Ø«Ù„Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©)
            const weightPatterns = [
                /GROSS WEIGHT[\s:]*([\d,]+)\s*Kg/i,       // Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                /Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠ\s*([\d.]+)/i,                     // Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                /ÙˆØ²Ù†\s*:\s*([\d.]+)/i,
                /Ø§Ù„ÙˆØ²Ù†\s*:\s*([\d.]+)/i,
                /([\d.,]+)\s*(ÙƒØ¬Ù…|kg|KG|Ú©ÛŒÙ„Ùˆ)/i
            ];
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            for (const pattern of weightPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const weightStr = match[1].replace(',', '.');
                    result.weight = parseFloat(weightStr);
                    break;
                }
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ (Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
            const netWeightMatch = text.match(/(?:NET WEIGHT|Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ)[\s:]*([\d,]+)\s*Kg/i);
            if (netWeightMatch) {
                result.netWeight = netWeightMatch[1].replace(',', '.') + ' ÙƒØ¬Ù…';
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ù† Ø§Ù„ØµÙˆØ±ØªÙŠÙ†)
            const productMatch = text.match(/(FROZEN BOVINE OFFALS|ÙØ±ÙŠØ´ ÙØ§Ø±Ù… ØµØ¯ÙˆØ± Ù…Ø¯Ø®Ù†Ø©|ØµÙ†Ù|Ù†ÙˆØ¹)[:\s]*(.*)/i);
            if (productMatch) {
                result.productType = productMatch[2].split('\n')[0].trim();
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
            const expiryMatch = text.match(/(?:EXPIRY DATE|ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)[\s:]*([\d\/]+)/i);
            if (expiryMatch) {
                result.expiryDate = expiryMatch[1];
            }
            
            return result;
        }
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
        function stopScanner() {
            try {
                isScanning = false;
                Quagga.stop();
                scanLine.style.display = 'none';
                statusText.textContent = "Ù…ØªÙˆÙ‚Ù";
                showNotification("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­");
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù:', err);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­");
            }
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function clearHistory() {
            scanHistory = [];
            currentWeight = 0;
            weightValue.textContent = "0.00";
            productType.textContent = "Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬: ---";
            netWeight.textContent = "Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ: ---";
            expiryDate.textContent = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ---";
            showNotification("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function exportHistory() {
            if (scanHistory.length === 0) {
                showError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
                return;
            }
            
            try {
                let csvContent = "Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…),Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬,Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ,ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡\n";
                
                scanHistory.forEach(item => {
                    csvContent += `${item.time},${item.weight},${item.productType || ''},${item.netWeight || ''},${item.expiryDate || ''}\n`;
                });
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `Ø³Ø¬Ù„_Ø§Ù„Ø£ÙˆØ²Ø§Ù†_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:', err);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            }
        }
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø§Ø¬Ø­
        function playScanSound() {
            try {
                scanSound.currentTime = 0;
                scanSound.play().catch(e => console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e));
            } catch (e) {
                console.log("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
            }
        }
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø®Ø·Ø£
        function playErrorSound() {
            try {
                errorSound.currentTime = 0;
                errorSound.play().catch(e => console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e));
            } catch (e) {
                console.log("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e);
            }
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message = "ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­") {
            notification.textContent = message;
            notification.classList.remove('error');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function showError(message) {
            notification.textContent = message;
            notification.classList.add('error', 'show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        stopBtn.addEventListener('click', stopScanner);
        clearBtn.addEventListener('click', clearHistory);
        exportBtn.addEventListener('click', exportHistory);
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (isScanning && Quagga) {
                Quagga.stop();
            }
        });
    </script>
</body>
</html>
